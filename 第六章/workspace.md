

## node_modulesç®€ä»‹

`node_modules` æ˜¯ Node.js é¡¹ç›®ä¸­çš„ä¸€ä¸ªç›®å½•ï¼Œç”¨äºå­˜æ”¾é¡¹ç›®çš„ä¾èµ–åŒ…ï¼ˆæ¨¡å—ï¼‰ã€‚

å½“æ‚¨åœ¨ Node.js é¡¹ç›®ä¸­ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æˆ–æ¨¡å—æ—¶ï¼Œé€šå¸¸ä¼šé€šè¿‡ npmï¼ˆNode.js åŒ…ç®¡ç†å™¨ï¼‰æˆ–å…¶ä»–åŒ…ç®¡ç†å·¥å…·æ¥å®‰è£…è¿™äº›ä¾èµ–é¡¹ã€‚å®‰è£…å®Œæˆåï¼Œç›¸å…³çš„ä¾èµ–åŒ…å°†ä¼šè¢«ä¸‹è½½å¹¶å­˜æ”¾åœ¨é¡¹ç›®çš„ `node_modules` ç›®å½•ä¸‹ã€‚

`node_modules` ç›®å½•æ˜¯ä¸€ä¸ªè‡ªåŠ¨åˆ›å»ºçš„ç›®å½•ï¼Œå®ƒä½äºé¡¹ç›®æ ¹ç›®å½•æˆ–å­ç›®å½•ä¸­ï¼ˆæ ¹æ®é¡¹ç›®çš„ç»“æ„è€Œå®šï¼‰ï¼Œç”¨äºç»„ç»‡å’Œå­˜å‚¨é¡¹ç›®æ‰€éœ€çš„ä¾èµ–é¡¹ã€‚  

## node_modulesæ£€ç´¢è§„åˆ™

åœ¨ Node.js ä¸­ï¼Œå½“éœ€è¦åŠ è½½æŸä¸ªåŒ…æ—¶ï¼ŒNode.js ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ¥æ£€ç´¢å¹¶åŠ è½½è¯¥åŒ…ã€‚æ£€ç´¢åŒ…çš„è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. æ£€æŸ¥å†…ç½®æ¨¡å—ï¼šé¦–å…ˆï¼ŒNode.js ä¼šæ£€æŸ¥æ‰€éœ€çš„æ¨¡å—æ˜¯å¦æ˜¯ Node.js çš„å†…ç½®æ¨¡å—ã€‚å†…ç½®æ¨¡å—æ˜¯ Node.js æä¾›çš„ä¸€äº›æ ¸å¿ƒæ¨¡å—ï¼Œå¦‚ `fs`ã€`http` ç­‰ã€‚å¦‚æœæ‰€éœ€æ¨¡å—æ˜¯å†…ç½®æ¨¡å—ï¼ŒNode.js ä¼šç›´æ¥åŠ è½½å®ƒã€‚

2. æ£€æŸ¥æ ¸å¿ƒæ¨¡å—ï¼šå¦‚æœæ‰€éœ€çš„æ¨¡å—ä¸æ˜¯å†…ç½®æ¨¡å—ï¼ŒNode.js ä¼šæ£€æŸ¥æ˜¯å¦æ˜¯æ ¸å¿ƒæ¨¡å—ã€‚æ ¸å¿ƒæ¨¡å—æ˜¯æŒ‡ Node.js é»˜è®¤æä¾›çš„æ¨¡å—ï¼Œå¦‚ `path`ã€`util` ç­‰ã€‚å¦‚æœæ‰€éœ€æ¨¡å—æ˜¯æ ¸å¿ƒæ¨¡å—ï¼ŒNode.js ä¼šç›´æ¥åŠ è½½å®ƒã€‚

3. æ£€æŸ¥å±€éƒ¨æ¨¡å—ï¼šå¦‚æœæ‰€éœ€æ¨¡å—æ—¢ä¸æ˜¯å†…ç½®æ¨¡å—ä¹Ÿä¸æ˜¯æ ¸å¿ƒæ¨¡å—ï¼ŒNode.js ä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºæ£€æŸ¥æ¨¡å—æ˜¯å¦å­˜åœ¨äºå±€éƒ¨å®‰è£…çš„ä¾èµ–é¡¹ä¸­ï¼š
   
   a. å½“å‰ç›®å½•çš„ `node_modules` ç›®å½•ï¼šNode.js é¦–å…ˆæ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„ `node_modules` ç›®å½•ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æ‰€éœ€æ¨¡å—çš„å®‰è£…ã€‚
   
   b. çˆ¶çº§ç›®å½•çš„ `node_modules` ç›®å½•ï¼šå¦‚æœå½“å‰ç›®å½•çš„ `node_modules` ç›®å½•ä¸­ä¸å­˜åœ¨æ‰€éœ€æ¨¡å—ï¼ŒNode.js ä¼šé€çº§å‘ä¸ŠæŸ¥æ‰¾çˆ¶çº§ç›®å½•ï¼Œç›´åˆ°æ‰¾åˆ°åŒ…å«æ‰€éœ€æ¨¡å—çš„ `node_modules` ç›®å½•ï¼Œæˆ–è€…åˆ°è¾¾æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•ã€‚

4. æ£€æŸ¥å…¨å±€æ¨¡å—ï¼šå¦‚æœæ‰€éœ€æ¨¡å—æ—¢ä¸æ˜¯å†…ç½®æ¨¡å—ã€æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿä¸å­˜åœ¨äºå±€éƒ¨å®‰è£…çš„ä¾èµ–é¡¹ä¸­ï¼ŒNode.js ä¼šæ£€æŸ¥æ˜¯å¦æ˜¯å…¨å±€å®‰è£…çš„æ¨¡å—ã€‚å…¨å±€å®‰è£…çš„æ¨¡å—æ˜¯é€šè¿‡ `npm install -g` å‘½ä»¤å®‰è£…çš„ã€‚Node.js ä¼šæ£€æŸ¥å…¨å±€å®‰è£…ç›®å½•ä¸­çš„ `node_modules` ç›®å½•ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æ‰€éœ€æ¨¡å—ã€‚

5. æŠ¥é”™ï¼šå¦‚æœä»¥ä¸Šæ­¥éª¤éƒ½æœªæ‰¾åˆ°æ‰€éœ€æ¨¡å—ï¼ŒNode.js ä¼šæŠ›å‡ºæ¨¡å—æœªæ‰¾åˆ°çš„é”™è¯¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æœ‰å¤šä¸ªç‰ˆæœ¬çš„æ¨¡å—å­˜åœ¨æ—¶ï¼ŒNode.js ä¼šæ ¹æ®æ¨¡å—çš„ä¾èµ–å…³ç³»å’ŒåŠ è½½é¡ºåºï¼Œä¼˜å…ˆåŠ è½½ç¬¦åˆä¾èµ–è¦æ±‚çš„æ¨¡å—ç‰ˆæœ¬ã€‚

æ€»ç»“èµ·æ¥ï¼ŒNode.js åœ¨åŠ è½½æ¨¡å—æ—¶ä¼šæŒ‰ç…§å†…ç½®æ¨¡å—ã€æ ¸å¿ƒæ¨¡å—ã€å±€éƒ¨æ¨¡å—å’Œå…¨å±€æ¨¡å—çš„é¡ºåºè¿›è¡Œæ£€ç´¢ã€‚è¿™æ ·çš„æ£€ç´¢è¿‡ç¨‹ç¡®ä¿äº†æ¨¡å—çš„æ­£ç¡®åŠ è½½ï¼Œå¹¶æ»¡è¶³ä¾èµ–å…³ç³»ã€‚





## node_modulesçš„å¼Šç«¯

### Dependency Hell ä¾èµ–åœ°ç‹±é—®é¢˜

ç°åœ¨é¡¹ç›®é‡Œæœ‰ä¸¤ä¸ªä¾èµ–Aå’ŒCï¼ŒAå’ŒCåˆ†åˆ«ä¾èµ–Bçš„ä¸åŒç‰ˆæœ¬ï¼Œå¦‚ä½•å¤„ç†

![1](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\1.png)

![2](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\2.png)

è¿™é‡Œå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1. é¦–å…ˆæ˜¯Bæœ¬èº«æ”¯æŒå¤šç‰ˆæœ¬å…±å­˜ï¼Œåªè¦Bæœ¬èº«æ²¡æœ‰å‰¯ä½œç”¨ï¼Œè¿™æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œä½†æ˜¯å¯¹äºå¾ˆå¤šåº“å¦‚core-jsä¼šæ±¡æŸ“å…¨å±€ç¯å¢ƒï¼Œæœ¬èº«å°±ä¸æ”¯æŒå¤šç‰ˆæœ¬å…±å­˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°½æ—©çš„è¿›è¡ŒæŠ¥é”™æç¤ºï¼ˆconflictçš„warningå’Œè¿è¡Œæ—¶çš„conflictçš„checkï¼‰

2. å¦‚æœBæœ¬èº«æ”¯æŒå¤šç‰ˆæœ¬å…±å­˜ï¼Œé‚£ä¹ˆéœ€è¦ä¿è¯Aæ­£ç¡®çš„åŠ è½½åˆ°B v1.0å’ŒCæ­£ç¡®çš„åŠ è½½åˆ°B v2.0
   
   æˆ‘ä»¬é‡ç‚¹è€ƒè™‘ç¬¬äºŒä¸ªé—®é¢˜ï¼šnodeçš„è§£å†³æ–¹å¼æ˜¯**ä¾èµ–çš„nodeåŠ è½½æ¨¡å—çš„è·¯å¾„æŸ¥æ‰¾ç®—æ³•å’Œnode_modulesçš„ç›®å½•ç»“æ„æ¥é…åˆ**



 å¦‚ä½•ä»node_modulesåŠ è½½packageï¼Ÿ

 æ ¸å¿ƒæ˜¯é€’å½’å‘ä¸ŠæŸ¥æ‰¾node_modulesé‡Œçš„packageï¼Œå¦‚æœåœ¨Â `'/home/ry/projects/foo.js'`Â æ–‡ä»¶é‡Œè°ƒç”¨äº†Â `require('bar.js')`ï¼Œåˆ™ Node.js ä¼šæŒ‰ä»¥ä¸‹é¡ºåºæŸ¥æ‰¾ï¼š

- `/home/ry/projects/node_modules/bar.js`

- `/home/ry/node_modules/bar.js`

- `/home/node_modules/bar.js`

- `/node_modules/bar.js`
  
  è¯¥ç®—æ³•æœ‰ä¸¤ä¸ªæ ¸å¿ƒï¼šï¼ˆ1ï¼‰ä¼˜å…ˆè¯»å–æœ€è¿‘çš„node_modulesçš„ä¾èµ–ï¼ˆ2ï¼‰é€’å½’å‘ä¸ŠæŸ¥æ‰¾node_modulesçš„ä¾èµ–
  
  è¯¥ç®—æ³•å³ç®€åŒ–äº† Dependency hell çš„è§£å†³æ–¹å¼ï¼Œä¹Ÿå¸¦æ¥äº†éå¸¸å¤šçš„é—®é¢˜



### node_modulesçš„ç›®å½•ç»“æ„

#### nest modeåµŒå¥—ç»“æ„

åˆ©ç”¨requireå…ˆåœ¨æœ€è¿‘çš„node_moduleé‡ŒæŸ¥æ‰¾ä¾èµ–çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬èƒ½æƒ³åˆ°ä¸€ä¸ªå¾ˆç®€å•çš„æ–¹å¼ï¼Œç›´æ¥åœ¨node_moduleç»´æŠ¤åŸæ¨¡å—çš„æ‹“æ‰‘å›¾å³å¯

![3](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\3.png)

è¿™æ ·æ ¹æ®mod-aå°±è¿‘çš„ä½¿ç”¨mod-bçš„1.0ç‰ˆæœ¬ï¼Œè€Œmod-cå°±è¿‘çš„ä½¿ç”¨äº†mod-bçš„2.0ç‰ˆæœ¬

 ä½†æ˜¯è¿™æ ·å¸¦æ¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬æ­¤æ—¶å†ä¾èµ–ä¸€ä¸ªmod-dï¼Œè¯¥mod-dä¹ŸåŒæ—¶ä¾èµ–çš„mod-bçš„2.0ç‰ˆæœ¬ï¼Œè¿™æ—¶å€™node_moduleså°±å˜æˆä¸‹é¢è¿™æ ·

![4](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\4.png)

 æˆ‘ä»¬å‘ç°è¿™é‡Œå­˜åœ¨ä¸ªé—®é¢˜ï¼Œè™½ç„¶ mod-a å’Œ mod-d ä¾èµ–äº†åŒä¸€ä¸ªmod-bçš„ç‰ˆæœ¬ï¼Œä½†æ˜¯mod-bå´å®‰è£…äº†ä¸¤éï¼Œå¦‚æœä½ çš„åº”ç”¨äº†å¾ˆå¤šçš„ç¬¬ä¸‰æ–¹åº“ï¼ŒåŒæ—¶ç¬¬ä¸‰æ–¹åº“å…±åŒä¾èµ–äº†ä¸€äº›å¾ˆåŸºç¡€çš„ç¬¬ä¸‰æ–¹åº“å¦‚lodashï¼Œä½ ä¼šå‘ç°ä½ çš„node_modulesé‡Œå……æ»¡äº†å„ç§é‡å¤ç‰ˆæœ¬çš„lodashï¼Œé€ æˆäº†æå¤§çš„ç©ºé—´æµªè´¹ï¼Œä¹Ÿå¯¼è‡´npm installå¾ˆæ…¢ï¼Œè¿™æ—¢æ˜¯ node_modules hell

#### flat mode å¹³å¦æ¨¡å¼

æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨å‘ä¸Šé€’å½’æŸ¥æ‰¾ä¾èµ–çš„ç‰¹æ€§ï¼Œå°†ä¸€äº›å…¬å…±ä¾èµ–æ”¾åœ¨å…¬å…±çš„node_moduleé‡Œ

![5](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\5.png)

æ ¹æ®requireçš„æŸ¥æ‰¾ç®—æ³•ï¼š

1. Aå’ŒDé¦–å…ˆä¼šå»è‡ªå·±çš„node_moduleé‡Œå»æŸ¥æ‰¾Bï¼Œå‘ç°ä¸å­˜åœ¨Bï¼Œç„¶åé€’å½’çš„å‘ä¸ŠæŸ¥æ‰¾ï¼Œæ­¤æ—¶æŸ¥æ‰¾åˆ°äº†Bçš„ v1.0ç‰ˆæœ¬ï¼Œç¬¦åˆé¢„æœŸ

2. Cä¼šå…ˆæŸ¥æ‰¾åˆ°è‡ªå·±çš„node_moduleé‡ŒæŸ¥æ‰¾åˆ°äº†B v2.0ï¼Œç¬¦åˆé¢„æœŸ
   
   è¿™æ—¶æˆ‘ä»¬å‘ç°äº†å³è§£å†³äº†depdency hellä¹Ÿé¿å…äº†npm2 çš„nestæ¨¡å¼å¯¼è‡´çš„é‡å¤ä¾èµ–é—®é¢˜



æ–°é—®é¢˜ ï¼š doppelgangers äºŒé‡èº«é—®é¢˜

ä½†æ˜¯é—®é¢˜å¹¶æ²¡æœ‰ç»“æŸï¼Œå¦‚æœæ­¤æ—¶å¼•å…¥çš„Dä¾èµ–çš„æ˜¯B v2.0ï¼Œè€Œå¼•å…¥çš„Eä¾èµ–çš„æ˜¯B v1.0ï¼Œæˆ‘ä»¬å‘ç°æ— è®ºæ˜¯æŠŠBv2.0è¿˜æ˜¯Bv1.0æ”¾åœ¨top levelï¼Œéƒ½ä¼šå¯¼è‡´ä»»ä½•å¦ä¸€ä¸ªç‰ˆæœ¬ä¼šå­˜åœ¨é‡å¤çš„é—®é¢˜ï¼Œå¦‚è¿™é‡Œçš„Bçš„v2.0çš„é‡å¤é—®é¢˜

![](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\6.png)

å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯è¿™æ ·ï¼Œä½†æœ‰å¯èƒ½é€ æˆå¾ˆå¤šé—®é¢˜

1.å…¨å±€å†²çª

2.ç ´ç¯å•ä¾‹æ¨¡å¼

3.Phantom dependency å¹»å½±ä¾èµ–

æˆ‘ä»¬å‘ç°flat modeç›¸æ¯”nest modeèŠ‚çœäº†å¾ˆå¤šçš„ç©ºé—´ï¼Œç„¶è€Œä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜å³phantom depdencyï¼Œè€ƒå¯Ÿä¸‹å¦‚ä¸‹çš„é¡¹ç›®

![](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\7.png)

![](D:\pzl\webpack-study\ç¬¬å…­ç« \imgs\8.png)

è¿™é‡Œçš„globå’Œbrace-expansionéƒ½ä¸åœ¨æˆ‘ä»¬çš„depdenciesé‡Œï¼Œä½†æ˜¯æˆ‘ä»¬å¼€å‘å’Œè¿è¡Œæ—¶éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼ˆå› ä¸ºè¿™ä¸ªæ˜¯rimrafçš„ä¾èµ–ï¼‰ï¼Œä¸€æ—¦å°†è¯¥åº“å‘å¸ƒï¼Œå› ä¸ºç”¨æˆ·å®‰è£…æˆ‘ä»¬çš„åº“çš„æ—¶å€™å¹¶ä¸ä¼šå®‰è£…åº“çš„devDepdencyï¼Œè¿™å¯¼è‡´åœ¨ç”¨æˆ·çš„åœ°æ–¹ä¼šè¿è¡ŒæŠ¥é”™ã€‚

 æˆ‘ä»¬æŠŠä¸€ä¸ªåº“ä½¿ç”¨äº†ä¸å±äºå…¶depdenciesé‡Œçš„packageç§°ä¹‹ä¸ºphantom depdenciesï¼Œphantom depdenciesä¸ä»…ä¼šå­˜åœ¨åº“é‡Œï¼Œå½“æˆ‘ä»¬ä½¿ç”¨monorepoç®¡ç†é¡¹ç›®çš„æƒ…å†µä¸‹ï¼Œé—®é¢˜æ›´åŠ ä¸¥é‡ï¼Œä¸€ä¸ªpackageä¸ä½†å¯èƒ½å¼•å…¥DevDependencyå¼•å…¥çš„phantomä¾èµ–ï¼Œæ›´å¾ˆæœ‰å¯èƒ½å¼•å…¥å…¶ä»–packageçš„ä¾èµ–ï¼Œå½“æˆ‘ä»¬éƒ¨ç½²é¡¹ç›®æˆ–è€…è¿è¡Œé¡¹ç›®çš„æ—¶å€™å°±å¯èƒ½å‡ºé—®é¢˜ã€‚

 åœ¨åŸºäºyarnæˆ–è€…npmçš„node_modulesçš„ç»“æ„ä¸‹ï¼Œdoppelgangerå’Œphantom dependencyä¼¼ä¹å¹¶æ²¡æœ‰å¤ªå¥½çš„è§£å†³æ–¹å¼ã€‚å…¶æœ¬è´¨æ˜¯å› ä¸ºnpmå’Œyarné€šè¿‡ node resolveç®—æ³•é…åˆnode_modulesçš„æ ‘å½¢ç»“æ„å¯¹åŸæœ¬depdency graphçš„æ¨¡æ‹Ÿ

### åç»­ä¸€ç³»åˆ—è§£å†³æ–¹æ¡ˆ

Semverã€lockã€pnpm



## workspace çš„å·¥ä½œåŸç†

workspaceså°±æ˜¯å¤šç©ºé—´çš„æ¦‚å¿µï¼Œåœ¨npmä¸­å¯ä»¥ç†è§£ä¸ºå¤šåŒ…ã€‚å®ƒçš„åˆè¡·æ˜¯ä¸ºäº†ç”¨æ¥è¿›è¡Œå¤šåŒ…ç®¡ç†çš„ï¼Œå®ƒå¯ä»¥è®©å¤šä¸ªnpmåŒ…åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­è¿›è¡Œå¼€å‘å’Œç®¡ç†å˜å¾—éå¸¸æ–¹ä¾¿ï¼š

- å®ƒä¼šå°†å­åŒ…ä¸­æ‰€æœ‰çš„ä¾èµ–åŒ…éƒ½æå‡åˆ°æ ¹ç›®å½•ä¸­è¿›è¡Œå®‰è£…ï¼Œæå‡åŒ…å®‰è£…çš„é€Ÿåº¦ï¼›
- å®ƒåˆå§‹åŒ–åä¼šè‡ªåŠ¨å°†å­åŒ…ä¹‹é—´çš„ä¾èµ–è¿›è¡Œå…³è”ï¼ˆè½¯é“¾æ¥ï¼‰ï¼›
- å› ä¸ºåŒä¸€ä¸ªé¡¹ç›®çš„å…³ç³»ï¼Œä»è€Œå¯ä»¥è®©å„ä¸ªå­åŒ…å…±äº«ä¸€äº›æµç¨‹ï¼Œæ¯”å¦‚ï¼šeslintã€stylelintã€git hooksã€publish flowç­‰ï¼›

è¿™ä¸ªè®¾è®¡æ¨¡å¼æœ€åˆæ¥è‡ªäºLernaï¼Œä½†Lernaå¯¹äºå¤šåŒ…ç®¡ç†ï¼Œæœ‰ç€æ›´å¼ºçš„èƒ½åŠ›ï¼Œè€Œä¸”æœ€æ–°ç‰ˆçš„Lernaå¯ä»¥å®Œå…¨å…¼å®¹npmæˆ–yarnçš„workspacesæ¨¡å¼ã€‚

## workspaceåŸºæœ¬ä½¿ç”¨

### å®šä¹‰å·¥ä½œåŒº

å·¥ä½œåŒºé€šå¸¸é€šè¿‡Â [`package.json`](https://nodejs.cn/npm/cli/v7/using-npm/workspaces/##12285fc8e0634ea4af346ca29954c3d7)Â æ–‡ä»¶çš„Â `workspaces`Â å±æ€§å®šä¹‰ï¼Œä¾‹å¦‚ï¼š

```json
{
  "name": "my-workspaces-powered-project",
  "workspaces": [
    "packages/workspace-a"
  ]
}
```

é‰´äºä¸Šè¿°Â `package.json`Â ç¤ºä¾‹ä½äºå½“å‰å·¥ä½œç›®å½•Â `.`Â ä¸­ï¼Œè¯¥ç›®å½•åŒ…å«ä¸€ä¸ªåä¸ºÂ `packages/workspace-a`Â çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹æœ¬èº«åŒ…å«ä¸€ä¸ªÂ `package.json`ï¼Œå®šä¹‰äº†ä¸€ä¸ª Node.js åŒ…ï¼Œä¾‹å¦‚ï¼š

```javascript
.
+-- package.json
`-- packages  
Â Â Â Â `-- workspace-a   
    Â Â Â Â `-- package.json
```

åœ¨å½“å‰å·¥ä½œç›®å½•Â `.`Â ä¸­è¿è¡ŒÂ `npm install`Â åï¼Œé¢„æœŸçš„ç»“æœæ˜¯æ–‡ä»¶å¤¹Â `workspace-a`Â å°†ç¬¦å·é“¾æ¥(npm link)åˆ°å½“å‰å·¥ä½œç›®å½•çš„Â `node_modules`Â æ–‡ä»¶å¤¹ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¸–å­Â `npm install`Â ç¤ºä¾‹ï¼Œå‡è®¾æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„å…ˆå‰ç¤ºä¾‹ç»“æ„ç›¸åŒï¼š

```lua
.
+-- node_modules
|  `-- workspace-a -> ../workspace-a
+-- package-lock.json
+-- package.json
    `-- packages
        `-- workspace-a
           `-- package.json
```

æ‚¨å¯ä»¥ä½¿ç”¨Â [npm init](https://nodejs.cn/npm/cli/v7/using-npm/workspaces/##3fb8eb84a281451cb52442883e847074)Â è‡ªåŠ¨æ‰§è¡Œå®šä¹‰æ–°å·¥ä½œåŒºæ‰€éœ€çš„æ­¥éª¤ã€‚ä¾‹å¦‚ï¼Œåœ¨å·²ç»å®šä¹‰äº†Â `package.json`Â çš„é¡¹ç›®ä¸­ï¼Œæ‚¨å¯ä»¥è¿è¡Œï¼š

```bash
npm init -w ./packages/a
```

æ­¤å‘½ä»¤å°†åˆ›å»ºä¸¢å¤±çš„æ–‡ä»¶å¤¹å’Œæ–°çš„Â `package.json`Â æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼ŒåŒæ—¶ç¡®ä¿æ­£ç¡®é…ç½®æ ¹é¡¹ç›®Â `package.json`Â çš„Â `"workspaces"`Â å±æ€§ã€‚

### å°†ä¾èµ–é¡¹æ·»åŠ åˆ°å·¥ä½œåŒº

å¯ä»¥ä½¿ç”¨Â `workspace`ç›´æ¥æ·»åŠ /åˆ é™¤/æ›´æ–°å·¥ä½œåŒºçš„ä¾èµ–é¡¹ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ä»¥ä¸‹ç»“æ„ï¼š

```lua
.
+-- package.json
`-- packages
   +-- dgov
   |   `-- package.json
   `-- dgov-mobile
       `-- package.json
```

å¦‚æœæ‚¨æƒ³ä»æ³¨å†Œè¡¨ä¸­æ·»åŠ ä¸€ä¸ªåä¸ºÂ `abbrev`Â çš„ä¾èµ–é¡¹ä½œä¸ºå·¥ä½œåŒº adgovçš„ä¾èµ–é¡¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å·¥ä½œåŒºé…ç½®å‘Šè¯‰ npm å®‰è£…ç¨‹åºåº”å°†åŒ…æ·»åŠ ä¸ºæ‰€æä¾›å·¥ä½œåŒºçš„ä¾èµ–é¡¹ï¼š

```css
npm install abbrev -w dgov
```

æ³¨æ„ï¼šå…¶ä»–å®‰è£…å‘½ä»¤å¦‚Â `uninstall`ã€`ci`Â ç­‰ä¹Ÿå°†å°Šé‡æä¾›çš„Â `workspace`Â é…ç½®ã€‚

### ä½¿ç”¨å·¥ä½œåŒº

ç»™å®šÂ [Node.js å¦‚ä½•å¤„ç†æ¨¡å—è§£æçš„ç»†èŠ‚](https://nodejs.cn/npm/cli/v7/using-npm/workspaces/##20950505e7a44cadb4f0c03d01d94612)ï¼Œå¯ä»¥é€šè¿‡å£°æ˜ä¸ºÂ `package.json`Â `name`Â æ¥ä½¿ç”¨ä»»ä½•å®šä¹‰çš„å·¥ä½œåŒºã€‚ç»§ç»­ä¸Šé¢å®šä¹‰çš„ç¤ºä¾‹ï¼Œè®©æˆ‘ä»¬è¿˜åˆ›å»ºä¸€ä¸ªéœ€è¦Â `workspace-a`Â ç¤ºä¾‹æ¨¡å—çš„ Node.js è„šæœ¬ï¼Œä¾‹å¦‚ï¼š

```javascript
// ./workspace-a/index.js
module.exports = 'a'

// ./lib/index.js
const moduleA = require('workspace-a')
console.log(moduleA) // -> a
```

è¿è¡Œæ—¶ï¼š

`node lib/index.js`

è¿™å±•ç¤ºäº†Â `node_modules`Â åˆ†è¾¨ç‡çš„æ€§è´¨å¦‚ä½•å…è®¸å·¥ä½œç©ºé—´å¯ç”¨å¯ç§»æ¤çš„å·¥ä½œæµç¨‹ï¼Œä»¥è¦æ±‚æ¯ä¸ªå·¥ä½œç©ºé—´ä¹Ÿæ˜“äºÂ [å‘å¸ƒ](https://nodejs.cn/npm/cli/v7/using-npm/workspaces/##016acc57550344aaafddf426069a8313)Â è¿™äº›åµŒå¥—çš„å·¥ä½œç©ºé—´åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚

### åœ¨å·¥ä½œåŒºä¸Šä¸‹æ–‡ä¸­è¿è¡Œå‘½ä»¤

æ‚¨å¯ä»¥ä½¿ç”¨Â `workspace`Â é…ç½®é€‰é¡¹åœ¨å·²é…ç½®å·¥ä½œåŒºçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œå‘½ä»¤ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•åœ¨åµŒå¥—å·¥ä½œåŒºçš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨Â `npm run`Â å‘½ä»¤çš„å¿«é€Ÿç¤ºä¾‹ã€‚å¯¹äºåŒ…å«å¤šä¸ªå·¥ä½œåŒºçš„é¡¹ç›®ï¼Œä¾‹å¦‚ï¼š

```lua
.
+-- package.json
`-- packages
   +-- a
   |   `-- package.json
   `-- b
       `-- package.json
```

é€šè¿‡ä½¿ç”¨Â `workspace`Â é€‰é¡¹è¿è¡Œå‘½ä»¤ï¼Œå¯ä»¥åœ¨è¯¥ç‰¹å®šå·¥ä½œåŒºçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œç»™å®šçš„å‘½ä»¤ã€‚ä¾‹å¦‚ï¼š

```bash
npm run test --workspace=a
```

è¿™å°†è¿è¡Œåœ¨Â `./packages/a/package.json`Â æ–‡ä»¶ä¸­å®šä¹‰çš„Â `test`Â è„šæœ¬ã€‚

è¯·æ³¨æ„ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­å¤šæ¬¡æŒ‡å®šæ­¤å‚æ•°ä»¥é’ˆå¯¹å¤šä¸ªå·¥ä½œåŒºï¼Œä¾‹å¦‚ï¼š

```bash
npm run test --workspace=a --workspace=b
```

ä¹Ÿå¯ä»¥ä½¿ç”¨Â `workspaces`ï¼ˆå¤æ•°ï¼‰é…ç½®é€‰é¡¹æ¥å¯ç”¨ç›¸åŒçš„è¡Œä¸ºï¼Œä½†åœ¨æ‰€æœ‰é…ç½®çš„å·¥ä½œåŒºçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œè¯¥å‘½ä»¤ã€‚ä¾‹å¦‚ï¼š

```bash
npm run test --workspaces
```

å°†åœ¨Â `./packages/a`Â å’ŒÂ `./packages/b`Â ä¸­è¿è¡ŒÂ `test`Â è„šæœ¬ã€‚

å‘½ä»¤å°†æŒ‰ç…§å®ƒä»¬åœ¨Â `package.json`Â ä¸­å‡ºç°çš„é¡ºåºåœ¨æ¯ä¸ªå·¥ä½œåŒºä¸­è¿è¡Œ

```json
{
  "workspaces": [ "packages/a", "packages/b" ]
}
```

è¿è¡Œé¡ºåºä¸ä»¥ä¸‹ä¸åŒï¼š

```json
{
  "workspaces": [ "packages/b", "packages/a" ]
}
```

è¯·æ³¨æ„ï¼Œ`npm workspace` åªé€‚ç”¨äº npm 7 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚



## ä¾‹å­

### 1. åˆ›å»ºé¡¹ç›®

```bash
mkdir demo-workspaces-multi-project
```

### 2. åˆå§‹åŒ–é¡¹ç›®

```bash
npm init -y
```

Â·.
â””â”€â”€ package.json` 

### 3. å£°æ˜æœ¬é¡¹ç›®æ˜¯workspacesæ¨¡å¼

`package.json`æ–°å¢é…ç½®ï¼š

```bash
"private":"true",
"workspaces": [
 "projects/*"
],
```

### 4. åˆå§‹åŒ–å­é¡¹ç›®`zoo`

åˆ›å»ºå­é¡¹ç›®`zoo`ï¼š

```bash
npm init -w package/zoo -y
```

`
.
â”œâ”€â”€ package.json
â””â”€â”€ packages
Â Â Â Â â””â”€â”€ zoo
 Â Â Â Â Â Â Â â””â”€â”€ package.json` 

åˆ›å»ºæ¨¡æ¿æ–‡ä»¶`index.html`ï¼Œä¸»å†…å®¹ä¸ºï¼š

```bash
<!-- package/zoo/index.html -->
<body>
  <h1>Welcome to Zoo!</h1>
  <div id="app"></div>
</body>
```

åˆ›å»ºé¡¹ç›®å…¥å£jsæ–‡ä»¶`index.js`ï¼Œå†…å®¹ä¸ºï¼š

```bash
console.log('Zoo')
```

å®‰è£…é¡¹ç›®æ„å»ºä¾èµ–åŒ…ï¼š

```bash
npm i -S webpack webpack-cli webpack-dev-server html-webpack-plugin webpack-merge --workspace=zoo

# projects/zoo/package.json
"private":"true",
"dependencies": {
  "html-webpack-plugin": "^5.5.0",
  "webpack": "^5.65.0",
  "webpack-cli": "^4.9.1",
  "webpack-dev-server": "^4.7.2"
}


```



åˆ›å»ºwebpacké…ç½®(æ­¤å¤„å¿½ç•¥ï¼Œå¯å»githubä¸Šçœ‹è¯¦ç»†é…ç½®)

zooä¸‹çš„`package.json`æ–°å¢å‘½ä»¤ï¼š

```bash
"scripts": {
  "dev": "webpack-dev-server --config webpack/dev.config.js --open",
  "prod": "webpack --config webpack/prod.config.js"
},


```

æ¥ä¸‹æ¥å°±å¯ä»¥è¿è¡Œäº†ï¼Œåªéœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä½¿ç”¨ï¼š

```bash
npm run dev --workspace=zoo
```

å³å¯è¿›è¡Œæœ¬åœ°å¼€å‘ã€‚

æ•ˆæœï¼š ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08c4fcfcac4943d58eced7d9879db0b7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

### 5. åˆå§‹åŒ–å­é¡¹ç›®`shop`

åˆ›å»ºå­é¡¹ç›®`shop`ï¼š

shell

å¤åˆ¶ä»£ç 

```bash
npm init -w package/shop -y
```

å…¶ä½™æ­¥éª¤åŒåˆå§‹åŒ–å­é¡¹ç›®`zoo`å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ã€‚

æœ€åçš„ç›®å½•ç»“æ„ï¼š ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2acea9e545fa41eabe6d65b836adc740~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

## å…±äº«

å¯¹äºMonorepoï¼Œå…±äº«æ˜¯æœ€é‡è¦çš„ä¸€ä¸ªä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥åšä¸€äº›å…±äº«çš„äº‹æƒ…ã€‚

### 1. åœ¨packagesä¸‹åŠ ä¸ª`share`ç©ºé—´ï¼Œä½œä¸ºå…±äº«èµ„æºç©ºé—´ï¼Œå¹¶åˆ›å»ºå…±äº«æ–‡ä»¶`Fish.js`ï¼š

```bash
npm init -w projects/share -y 
mkdir projects/share/js
touch projects/share/js/Fish.js`
```

```bash
// projects/share/js/Fish.js
class Fish {
 constructor(name, age) {
 this.name = name
 this.age = age
 }
 swim() {
 console.log('swim~')
 }
 print() {
 return 'ğŸŸ '
 }
}
module.exports = Fish
```

å­é¡¹ç›®`zoo`çš„å…¥å£æ–‡ä»¶æ”¹ä¸ºï¼š

```javascript
// projects/zoo/src/index.js
const Fish = require('share/js/Fish')
const fish = new Fish()
document.getElementById('app').textContent = fish.print()
```



è¿è¡Œ`zoo`çš„`dev`çœ‹æ•ˆæœï¼š ![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa966e365b3744178237922cc8bdab46~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

ä¿®æ”¹å­é¡¹ç›®`shop`çš„å…¥å£æ–‡ä»¶åï¼Œä¼šå‡ºç°åŒæ ·çš„æ•ˆæœã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œshareæ–‡ä»¶å¤¹ä¸‹çš„ä¸œè¥¿ï¼Œ`zoo`å’Œ`shop`å¯ä»¥å…¬ç”¨äº†ï¼Œéœ€è¦åšçš„ä»…ä»…æ˜¯æ–°å¢ä¸€ä¸ªwebpackçš„`alias`è€Œå·²ï¼ğŸ‰



ä¼˜ç‚¹ï¼šä¾¿æ·çš„é¡¹ç›®ç®¡ç†ï¼Œå…±äº«ä¾èµ–é¡¹ï¼Œç»Ÿä¸€çš„é…ç½®å’Œè„šæœ¬ï¼Œå­é¡¹ç›®çš„ç‹¬ç«‹æ€§ï¼Œç®€åŒ–çš„æ„å»ºå’Œéƒ¨ç½²ï¼Œäº¤å‰å¼•ç”¨å’Œè°ƒè¯•



## é£é™©ï¼š

## å‘ä¸€ï¼šnpm install é»˜è®¤æ¨¡å¼çš„å‘

npm v7å¼€å§‹ï¼Œinstallä¼šé»˜è®¤å®‰è£…ä¾èµ–åŒ…ä¸­çš„`peerDependencies`å£°æ˜çš„åŒ…ã€‚æ–°é¡¹ç›®å¯èƒ½å½±å“ä¸å¤§ï¼Œä½†æ˜¯ï¼Œå¦‚æœä½ æ˜¯æ”¹é€ ç°æœ‰çš„é¡¹ç›®ã€‚å› ä¸ºç”¨äº†ç»Ÿä¸€ç®¡ç†çš„æ–¹å¼ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä¼šæŠŠå­é¡¹ç›®ä¸­çš„lockæ–‡ä»¶åˆ æ‰ï¼Œåœ¨æ ¹ç›®å½•ç”¨ç»Ÿä¸€çš„lockç®¡ç†ã€‚ç„¶åï¼Œå½“ä½ è¿™ä¹ˆåšäº†ä»¥åï¼Œå¯èƒ½å‘çˆ¹çš„äº‹æƒ…å°±å‡ºç°äº†ã€‚
åœºæ™¯ï¼šæˆ‘çš„å­é¡¹ç›®ä¸­ç”¨çš„æ˜¯`webpack4`ï¼Œç„¶åï¼Œæˆ‘ä»¬çš„æ„å»ºç›¸å…³çš„å·¥å…·ï¼ˆwebpackã€babelã€postcssã€eslintã€stylintç­‰ï¼‰éƒ½ä¼šå°è£…åˆ°åŸºç¡€åŒ…ä¸­ã€‚è¿™äº›åŒ…çš„ä¾èµ–åŒ…ä¸­æœ‰ä¸€ä¸ªåŒ…ï¼Œåœ¨`package.json`å£°æ˜ä¸­ä½¿ç”¨è¿™æ ·å†™ï¼š

json

å¤åˆ¶ä»£ç 

`"peerDependencies": {
 "webpack": "^5.1.0"
},` 

ç„¶åï¼Œåœ¨æ ¹ç›®å½•ä¸­`npm install`ï¼Œç„¶åå†è·‘å­é¡¹ç›®å‘ç°é¡¹ç›®è·‘ä¸èµ·æ¥äº†ã€‚åŸå› å°±æ˜¯ï¼Œé¡¹ç›®å±…ç„¶å®‰è£…çš„æ˜¯`webpack5`çš„ç‰ˆæœ¬ï¼

### è§£å†³æ–¹æ¡ˆ

- æ–¹æ¡ˆ1ï¼šåœ¨å­é¡¹ç›®çš„`package.json`ä¸­æ˜¾ç¤ºå£°æ˜ç”¨çš„`webpack`ç‰ˆæœ¬ï¼›
- æ–¹æ¡ˆ2ï¼šå»githubå’Œä½œè€…å•†é‡ä¿®å¤ä¾èµ–åŒ…ï¼Œå¦‚æœä»–çš„åŒ…å³å…¼å®¹`webpack4`ä¹Ÿå…¼å®¹`webpack5`ï¼Œåº”è¯¥å†™æˆï¼ŒæŠŠå£°æ˜æ”¹ä¸ºï¼š `"webpack": "^4.0.0 || ^5.0.0"`
- æ–¹æ¡ˆ3ï¼š`npm install --legacy-peer-deps`




